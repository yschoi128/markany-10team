<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI PT ìŒ¤</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: #1a1a1a; color: #e0e0e0; }
        .container { max-width: 800px; margin: 0 auto; height: 100vh; display: flex; flex-direction: column; background: #2a2a2a; }
        .header { padding: 20px; background: #1f1f1f; border-bottom: 1px solid #333; display: flex; justify-content: space-between; align-items: center; }
        .header h1 { font-size: 24px; }
        .menu-btn { background: none; border: none; color: #e0e0e0; font-size: 20px; cursor: pointer; padding: 8px; }
        .messages { flex: 1; overflow-y: auto; padding: 20px; }
        .message { margin-bottom: 15px; display: flex; }
        .message.user { justify-content: flex-end; }
        .message.ai { justify-content: flex-start; }
        .message-content { max-width: 70%; padding: 12px 16px; border-radius: 18px; line-height: 1.5; }
        .message-content p { margin: 0.5em 0; }
        .message-content ul { margin: 0.5em 0; padding-left: 1.5em; }
        .message-content li { margin: 0.2em 0; }
        .message-content strong { font-weight: 600; }
        .message-content em { font-style: italic; }
        .message-content code { background: rgba(255,255,255,0.1); padding: 2px 4px; border-radius: 3px; font-family: monospace; }
        .user .message-content { background: #4a90e2; color: white; }
        .ai .message-content { background: #3a3a3a; color: #e0e0e0; }
        .input-area { padding: 20px; border-top: 1px solid #333; }
        .input-wrapper { display: flex; background: #1a1a1a; border-radius: 25px; border: 1px solid #444; }
        .input-wrapper input { flex: 1; background: transparent; border: none; padding: 16px 20px; color: #e0e0e0; outline: none; }
        .input-wrapper input::placeholder { color: #888; }
        .send-btn { width: 40px; height: 40px; background: #4a90e2; border: none; border-radius: 50%; color: white; cursor: pointer; margin: 4px; }
        .send-btn:disabled { background: #666; }
        .modal { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; }
        .modal-content { background: #2a2a2a; padding: 30px; border-radius: 12px; width: 400px; max-width: 90vw; }
        .modal-content h2 { margin-bottom: 20px; text-align: center; }
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 5px; }
        .form-group input, .form-group select { width: 100%; padding: 10px; background: #1a1a1a; border: 1px solid #444; border-radius: 6px; color: #e0e0e0; }
        .buttons { display: flex; gap: 10px; margin-top: 20px; }
        .btn { flex: 1; padding: 12px; border: none; border-radius: 6px; cursor: pointer; }
        .btn-cancel { background: #666; color: white; }
        .btn-save { background: #4a90e2; color: white; }
        .image-preview { margin-bottom: 10px; position: relative; display: inline-block; }
        .image-preview img { max-width: 200px; border-radius: 8px; }
        .remove-btn { position: absolute; top: -8px; right: -8px; width: 24px; height: 24px; background: #ff4444; color: white; border: none; border-radius: 50%; cursor: pointer; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¤– AI PT ìŒ¤</h1>
            <button class="menu-btn" onclick="showSettings()">âš™ï¸</button>
        </div>
        
        <div class="messages" id="messages">
            <!-- ë©”ì‹œì§€ë“¤ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ --> 
        </div>
        
        <div class="input-area">
            <div id="imagePreview"></div>
            <div class="input-wrapper">
                <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." onkeypress="handleKeyPress(event)">
                <input type="file" id="fileInput" accept="image/*" style="display:none" onchange="handleFileSelect(event)">
                <button onclick="document.getElementById('fileInput').click()" style="background:none;border:none;color:#888;font-size:20px;padding:8px;cursor:pointer;" title="ì´ë¯¸ì§€ ì²¨ë¶€">ğŸ“</button>
                <button class="send-btn" onclick="sendMessage()" id="sendBtn" title="ì „ì†¡">â¤</button>
            </div>
        </div>
    </div>

    <!-- ì„¤ì • ëª¨ë‹¬ -->
    <div id="settingsModal" class="modal" style="display:none;">
        <div class="modal-content">
            <h2>í”„ë¡œí•„ ì„¤ì •</h2>
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="userName" placeholder="ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ë‚˜ì´</label>
                <input type="number" id="userAge" placeholder="ë‚˜ì´ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì„±ë³„</label>
                <select id="userGender">
                    <option value="">ì„ íƒí•˜ì„¸ìš”</option>
                    <option value="male">ë‚¨ì„±</option>
                    <option value="female">ì—¬ì„±</option>
                </select>
            </div>
            <div class="form-group">
                <label>í‚¤ (cm)</label>
                <input type="number" id="userHeight" placeholder="í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ì²´ì¤‘ (kg)</label>
                <input type="number" id="userWeight" placeholder="ì²´ì¤‘ì„ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            <div class="form-group">
                <label>ëª©í‘œ</label>
                <select id="userGoal">
                    <option value="health_maintenance">ê±´ê°• ìœ ì§€</option>
                    <option value="weight_loss">ì²´ì¤‘ ê°ëŸ‰</option>
                    <option value="muscle_gain">ê·¼ìœ¡ ì¦ê°€</option>
                </select>
            </div>
            <div class="buttons">
                <button class="btn btn-cancel" onclick="hideSettings()">ì·¨ì†Œ</button>
                <button class="btn btn-save" onclick="saveProfile()">ì €ì¥</button>
            </div>
        </div>
    </div>

    <script>
        let selectedFile = null;
        let isLoading = false;
        let currentUserId = localStorage.getItem('currentUserId') || null;

        function showSettings() {
            document.getElementById('settingsModal').style.display = 'flex';
        }

        function hideSettings() {
            document.getElementById('settingsModal').style.display = 'none';
        }

        function handleKeyPress(event) {
            if (event.key === 'Enter' && !event.shiftKey) {
                event.preventDefault();
                sendMessage();
            }
        }

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (file && file.type.startsWith('image/')) {
                selectedFile = file;
                const reader = new FileReader();
                reader.onload = function(e) {
                    document.getElementById('imagePreview').innerHTML = 
                        `<div class="image-preview">
                            <img src="${e.target.result}" alt="ì„ íƒëœ ì´ë¯¸ì§€">
                            <button class="remove-btn" onclick="removeImage()">Ã—</button>
                        </div>`;
                    // ì´ë¯¸ì§€ ì„ íƒ í›„ ì…ë ¥ í•„ë“œì— í¬ì»¤ìŠ¤
                    document.getElementById('messageInput').focus();
                    document.getElementById('messageInput').placeholder = 'ì´ë¯¸ì§€ì— ëŒ€í•œ ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
                };
                reader.readAsDataURL(file);
            }
        }

        function removeImage() {
            selectedFile = null;
            document.getElementById('imagePreview').innerHTML = '';
            document.getElementById('fileInput').value = '';
            document.getElementById('messageInput').placeholder = 'ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”...';
        }

        // ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ í•¨ìˆ˜
        function renderMarkdown(text) {
            return text
                .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')
                .replace(/\*(.*?)\*/g, '<em>$1</em>')
                .replace(/`(.*?)`/g, '<code>$1</code>')
                .replace(/\n\n/g, '</p><p>')
                .replace(/\n/g, '<br>')
                .replace(/^(.+)$/gm, '<p>$1</p>')
                .replace(/<p><\/p>/g, '')
                .replace(/^\d+\. (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ol>$1</ol>')
                .replace(/^- (.+)$/gm, '<li>$1</li>')
                .replace(/(<li>.*<\/li>)/s, '<ul>$1</ul>');
        }
        
        function addMessage(text, sender, image = null) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${sender}`;
            
            let content = '';
            if (image) {
                content += `<img src="${image}" style="max-width:300px;border-radius:8px;margin-bottom:8px;display:block;">`;
            }
            
            // AI ë©”ì‹œì§€ëŠ” ë§ˆí¬ë‹¤ìš´ ë Œë”ë§ ì ìš©
            if (sender === 'ai') {
                content += renderMarkdown(text);
            } else {
                content += `<div>${text}</div>`;
            }
            
            messageDiv.innerHTML = `<div class="message-content">${content}</div>`;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        async function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if ((!message && !selectedFile) || isLoading) return;
            
            // ì‚¬ìš©ì ë©”ì‹œì§€ í‘œì‹œ (ì´ë¯¸ì§€ì™€ í•¨ê»˜)
            const imagePreview = selectedFile ? URL.createObjectURL(selectedFile) : null;
            if (selectedFile && !message) {
                addMessage('ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.', 'user', imagePreview);
            } else {
                addMessage(message, 'user', imagePreview);
            }
            
            // ì…ë ¥ ì´ˆê¸°í™”
            input.value = '';
            const currentFile = selectedFile;
            removeImage();
            
            // ë¡œë”© ìƒíƒœ
            isLoading = true;
            document.getElementById('sendBtn').disabled = true;
            addMessage('ë‹µë³€ì„ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...', 'ai');
            
            try {
                let safeUserId = currentUserId || 'user' + Date.now();
                // í•œê¸€ ì´ë¦„ë„ ê·¸ëŒ€ë¡œ ì‚¬ìš©
                if (!safeUserId || safeUserId.trim() === '') {
                    safeUserId = 'user' + Date.now();
                }
                console.log('Using user_id:', safeUserId);
                const messageText = message || 'ì´ë¯¸ì§€ë¥¼ ë¶„ì„í•´ì£¼ì„¸ìš”.';
                
                console.log('Current userId from storage:', currentUserId);
                console.log('Sending request with:', { user_id: safeUserId, message: messageText });
                
                const formData = new FormData();
                formData.append('user_id', safeUserId);
                formData.append('message', messageText);
                
                if (currentFile) {
                    formData.append('image', currentFile);
                }
                
                // FormData ë‚´ìš© í™•ì¸
                for (let [key, value] of formData.entries()) {
                    console.log(key, value);
                }
                
                let response;
                if (currentFile) {
                    // ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ Form ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    response = await fetch('http://3.35.165.130:8001/chat', {
                        method: 'POST',
                        body: formData
                    });
                } else {
                    // í…ìŠ¤íŠ¸ë§Œ ìˆìœ¼ë©´ JSON ì—”ë“œí¬ì¸íŠ¸ ì‚¬ìš©
                    response = await fetch('http://3.35.165.130:8001/chat/json', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            user_id: safeUserId,
                            message: messageText
                        })
                    });
                }
                
                const result = await response.json();
                
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const messages = document.getElementById('messages');
                messages.removeChild(messages.lastChild);
                
                console.log('API Response:', result);
                console.log('Result structure:', JSON.stringify(result, null, 2));
                
                if (result.success && result.data && result.data.response) {
                    addMessage(result.data.response, 'ai');
                } else if (result.success && result.data && result.data.success && result.data.response) {
                    addMessage(result.data.response, 'ai');
                } else {
                    console.error('Response error:', result);
                    addMessage(`ì˜¤ë¥˜: ${JSON.stringify(result.data?.error || result.message || 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.')}`, 'ai');
                }
            } catch (error) {
                // ë¡œë”© ë©”ì‹œì§€ ì œê±°
                const messages = document.getElementById('messages');
                messages.removeChild(messages.lastChild);
                addMessage(`ì„œë²„ ì—°ê²°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ${error.message}`, 'ai');
            } finally {
                isLoading = false;
                document.getElementById('sendBtn').disabled = false;
            }
        }

        async function saveProfile() {
            const name = document.getElementById('userName').value;
            const age = document.getElementById('userAge').value;
            const gender = document.getElementById('userGender').value;
            const height = document.getElementById('userHeight').value;
            const weight = document.getElementById('userWeight').value;
            const goal = document.getElementById('userGoal').value;
            
            if (!name || !age || !gender || !height || !weight) {
                alert('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const response = await fetch('http://3.35.165.130:8001/mcp/tools/call', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        name: 'create_user_profile',
                        arguments: {
                            user_id: name,
                            name: name,
                            age: parseInt(age),
                            gender: gender,
                            height: parseFloat(height),
                            weight: parseFloat(weight),
                            health_goal: goal
                        }
                    })
                });
                
                const data = await response.json();
                console.log('Profile API Response:', data);
                
                console.log('Full API Response:', data);
                
                let result;
                if (data.content && data.content[0] && data.content[0].text) {
                    try {
                        result = JSON.parse(data.content[0].text);
                    } catch (parseError) {
                        console.error('JSON Parse Error:', parseError);
                        throw new Error('ì‘ë‹µ íŒŒì‹± ì˜¤ë¥˜: ' + parseError.message);
                    }
                } else if (data.success !== undefined) {
                    result = data;
                } else {
                    console.error('Unexpected response format:', data);
                    throw new Error('ì˜ˆìƒí•˜ì§€ ëª»í•œ ì‘ë‹µ í˜•ì‹ì…ë‹ˆë‹¤.');
                }
                
                if (result.success) {
                    currentUserId = name;
                    localStorage.setItem('currentUserId', name);
                    document.querySelector('.header h1').textContent = `ğŸ¤– ${name}ë‹˜ì˜ AI PT ìŒ¤`;
                    alert(`í”„ë¡œí•„ì´ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤!\nBMI: ${result.bmi}\nëª©í‘œ ì¹¼ë¡œë¦¬: ${result.target_calories}kcal`);
                    hideSettings();
                    addMessage(`${name}ë‹˜, í”„ë¡œí•„ ì„¤ì •ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤! ì´ì œ ê°œì¸í™”ëœ ì‹ë‹¨ ìƒë‹´ì„ ì‹œì‘í•´ë³´ì„¸ìš”.`, 'ai');
                    console.log('Profile created, currentUserId set to:', name);
                } else {
                    alert('í”„ë¡œí•„ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤: ' + result.error);
                }
            } catch (error) {
                alert('í”„ë¡œí•„ ìƒì„± ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error.message);
            }
        }

        // ì´ˆê¸°í™”
        window.onload = function() {
            // í•­ìƒ ìƒˆë¡œìš´ ì‚¬ìš©ìë¡œ ì‹œì‘
            addMessage('ì•ˆë…•í•˜ì„¸ìš”! AI PT ìŒ¤ì…ë‹ˆë‹¤. ë¨¼ì € í”„ë¡œí•„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”. âš™ï¸ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.', 'ai');
        };
    </script>
</body>
</html>